<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>ASCII Road Game</title>
<style>
body {
  margin:0;
  height:100vh;
  background:#000;
  font-family:monospace;
  white-space:pre;
  overflow:hidden;
}
.car {
  position:absolute;
  font-weight:bold;
  will-change:transform;
}
.lane, .divider {
  position:absolute;
  width:100%;
  pointer-events:none;
}
.lane {
  border-top:1px solid gray;
  opacity:.3;
}
.divider {
  border-top:4px double yellow;
  opacity:.8;
}
#player {
  position:absolute;
  font-weight:bold;
  font-size:24px;
  left:50%;
  transform:translateX(-50%);
}
#score {
  position:absolute;
  top:230px;
  left:50%;
  transform:translateX(-50%);
  color:#fff;
  font-size:20px;
}
#hud {
  position:absolute;
  top:260px;
  left:50%;
  transform:translateX(-50%);
  color:lime;
  font-size:18px;
  white-space:nowrap; /* все в один рядок */
}
#hud span {
  transition:color .3s;
  margin-right:12px;
}
#gameover {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  color:red;
  font-size:28px;
  display:none;
  flex-direction:column;
  align-items:center;
  text-align:center;
}
#gameover #gameover-text {
  margin-bottom:20px;
  white-space:pre-line;
}
button {
  font-size:20px;
  padding:10px 20px;
  margin:5px;
  background:#222;
  color:#fff;
  border:1px solid gray;
  border-radius:8px;
}
#controls {
  position:absolute;
  bottom:50px;
  left:50%;
  transform:translateX(-50%);
}
</style>
</head>
<body>
<div id="gameover">
  <div id="gameover-text"></div>
  <button onclick="restartGame()">Почати спочатку</button>
</div>

<div id="controls">
  <button onclick="movePlayer(-1)">⬆</button>
  <button onclick="movePlayer(1)">⬇</button>
</div>

<div id="score">00:00:0</div>
<div id="hud">
  <span id="hud-gear"></span>
  <span id="hud-cars"></span>
  <span id="hud-shields"></span>
</div>
<div id="player">:=[:]=:</div>

<script>
const carSprites=['=(o)≡','≡[+]≡','(o)=(o)=[:]','=[:]=','<[•)>','=[-]=','[]=o=[]','<(o)>'];
const carColors=['red','orange','yellow','lime','cyan','blue','magenta','white'];
const laneCount=3, laneHeight=30, safeDistance=7;
let laneTops=[], maxCells=Math.floor(innerWidth/10);
let cars=[], fastCars=[], trucks=[], motorcyclists=[];
let carsPassed=0, kmh=20, gear=1, shields=0, lastSide=null, speedMultiplier=1;
let startTime, gameOver=false, playerLane=laneCount;
let fastCarTimer=null, truckTimer=null, motoTimer=null;

const player=document.getElementById('player');
const gearNames=["ПЕРША передача","ДРУГА передача","ТРЕТЯ передача","ЧЕТВЕРТА передача","П’ЯТА передача"];

function updateHud(changed=""){
  const g=document.getElementById("hud-gear"),
        c=document.getElementById("hud-cars"),
        h=document.getElementById("hud-shields");
  g.innerText=`${gearNames[gear-1]} (${kmh}км/год)`;
  c.innerText=`Уникнутих зіткнень: ${carsPassed}`;
  h.innerText=`Щити: ${shields}`;
  [g,c,h].forEach(el=>{
    el.style.color=el.id===changed?"yellow":"lime";
    if(el.id===changed)setTimeout(()=>{if(!gameOver)el.style.color="lime"},1000);
  });
}

function initLanes(){
  laneTops=Array.from({length:laneCount*2},(_,i)=>i*laneHeight+(i>=laneCount?laneHeight/2:0));
  laneTops.forEach(t=>addEl('lane',t));
  [laneCount*laneHeight,laneCount*laneHeight+laneHeight/2].forEach(t=>addEl('divider',t));
  addEl('lane',laneTops.at(-1)+laneHeight);
}
function addEl(cls,top){
  const el=document.createElement('div');
  el.className=cls; el.style.top=top+'px';
  document.body.appendChild(el); return el;
}

function updatePlayerPos(){player.style.top=(laneTops[playerLane]+5)+'px'}
function movePlayer(dir){
  playerLane=Math.max(0,Math.min(laneTops.length-1,playerLane+dir));
  updatePlayerPos();
  if(playerLane===0)lastSide=0;
  if(playerLane===laneTops.length-1&&lastSide===0){
    shields++; lastSide=null; updateHud("hud-shields");
  }
  if(playerLane===laneTops.length-1)lastSide=1;
  if(playerLane===0&&lastSide===1){
    shields++; lastSide=null; updateHud("hud-shields");
  }
}
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowUp')movePlayer(-1);
  if(e.key==='ArrowDown')movePlayer(1);
});
updatePlayerPos();

setInterval(()=>{player.innerHTML=player.innerText.split('').map(ch=>{
  if(ch===':')return`<span style="color:${Math.random()>.5?'red':'blue'}">:</span>`;
  if(ch==='=')return`<span style="color:${Math.random()>.5?'blue':'white'}">=</span>`;
  return ch;
}).join('');},300);

function initCars(mult=1){
  for(let m=0;m<mult;m++){
    carSprites.forEach((sprite,i)=>{
      const lane=i%(laneCount*2), el=document.createElement('div');
      el.className='car'; el.textContent=sprite;
      el.style.color=carColors[i%carColors.length];
      el.style.top=laneTops[lane]+(lane===laneCount?12:5)+'px';
      document.body.appendChild(el);
      cars.push({
        element:el,
        x:Math.random()*maxCells,
        spriteLen:sprite.length,
        speed:(0.5+Math.random()*2)/16,
        direction:lane<laneCount?-1:1,
        lane,
        currentSpeed:0,
        removed:false
      });
    });
  }
}
function adjustSpeeds(){
  const byLane={};
  cars.forEach(c=>(byLane[c.lane]??=[]).push(c));
  for(const lane in byLane){
    const arr=byLane[lane].sort((a,b)=>a.x-b.x);
    arr.forEach((car,idx)=>{
      const n=car.direction>0?arr[idx+1]:arr[idx-1];
      let slowed=false;
      if(n){
        const dist=Math.abs(n.x-car.x);
        if((car.direction>0&&n.x>car.x&&dist<safeDistance)||
           (car.direction<0&&car.x>n.x&&dist<safeDistance))slowed=true;
      }
      car.currentSpeed=slowed?car.speed*0.3:car.speed;
    });
  }
}

function spawnFastCar(){
  if(gameOver)return;
  const lane=Math.floor(Math.random()*laneTops.length);
  const el=document.createElement('div');
  el.className='car'; el.textContent='(o)=(o)';
  el.style.top=laneTops[lane]+5+'px';
  document.body.appendChild(el);
  const car={
    element:el,
    x:lane<laneCount?maxCells+5:-5,
    spriteLen:5,
    speed:0.8, // фіксована швидкість
    direction:lane<laneCount?-1:1,
    lane,
    removed:false,
    fast:true
  };
  el.colorTimer=setInterval(()=>{el.style.color=['red','yellow','lime','cyan','magenta','white'][Math.floor(Math.random()*6)]},200);
  fastCars.push(car);
}

function spawnTruck(){
  if(gameOver||carsPassed<20)return;
  const lane=Math.floor(Math.random()*laneTops.length);
  const el=document.createElement('div');
  el.className='car'; el.textContent='[=====TRUCK=====]';
  el.style.top=laneTops[lane]+5+'px';
  document.body.appendChild(el);
  const t={
    element:el,
    x:lane<laneCount?maxCells+10:-20,
    spriteLen:16,
    speed:0.5/16,
    direction:lane<laneCount?-1:1,
    lane,
    removed:false
  };
  el.colorTimer=setInterval(()=>{el.style.color=['yellow','white','orange'][Math.floor(Math.random()*3)]},400);
  trucks.push(t);
}

function spawnMotorcyclists(){
  if(gameOver||carsPassed<30)return;
  const lane=Math.floor(Math.random()*(laneTops.length-1));
  const el1=document.createElement('div'), el2=document.createElement('div');
  el1.className=el2.className='car';
  el1.textContent=el2.textContent='(o)≡(o)';
  el1.style.color=el2.style.color='white';
  el1.style.top=laneTops[lane]+5+'px';
  el2.style.top=laneTops[lane+1]+5+'px';
  document.body.appendChild(el1); document.body.appendChild(el2);
  motorcyclists.push({
    elements:[el1,el2],
    x:lane<laneCount?maxCells+5:-10,
    speed:0.8/2, // удвічі повільніше fastCars
    direction:lane<laneCount?-1:1,
    lanes:[lane,lane+1],
    removed:false
  });
}

function checkCollision(car){
  if(car.removed)return;
  const carLeft=car.x*10, carRight=carLeft+car.spriteLen*10;
  const pl=parseFloat(player.offsetLeft), pr=pl+player.offsetWidth;
  if(car.lane===playerLane&&!(carRight<pl||carLeft>pr)){
    if(shields>0){
      shields--; updateHud("hud-shields");
      car.removed=true; car.element.remove();
    }else endGame();
  }
}
function checkMotorcyclists(mc){
  if(mc.removed)return;
  const pl=parseFloat(player.offsetLeft), pr=pl+player.offsetWidth;
  mc.lanes.forEach((lane,i)=>{
    if(lane===playerLane){
      const el=mc.elements[i], cl=mc.x*10, cr=cl+el.textContent.length*10;
      if(!(cr<pl||cl>pr)){
        if(shields>0){
          shields--; updateHud("hud-shields");
          mc.elements.forEach(e=>e.remove()); mc.removed=true;
        }else endGame();
      }
    }
  });
}

function updateCar(c){
  if(c.removed)return false;
  if(c.fast) c.x+=c.speed*c.direction;
  else {
    adjustSpeeds();
    c.x+=(c.currentSpeed||c.speed)*c.direction*speedMultiplier;
  }
  if(c.direction>0?c.x>maxCells:c.x<-c.spriteLen){
    if(c.fast){
      c.element.remove(); return false;
    }else{
      c.x=c.direction>0?-c.spriteLen:maxCells;
      carsPassed++; updateHud("hud-cars");
      if(carsPassed===10){gear=2; kmh=40; speedMultiplier=2; updateHud("hud-gear");}
      if(carsPassed===20){gear=3; kmh=60; speedMultiplier=3; updateHud("hud-gear");}
      if(carsPassed===30){gear=4; kmh=80; speedMultiplier=4; updateHud("hud-gear");}
      if(carsPassed===40){
        gear=5; kmh=100; speedMultiplier=5; updateHud("hud-gear");
        // після П’ЯТОЇ передачі fastCars удвічі частіше
        clearInterval(fastCarTimer);
        fastCarTimer=setInterval(spawnFastCar,5000);
      }
    }
  }
  c.element.style.transform=`translateX(${c.x*10}px)`;
  checkCollision(c);
  return true;
}
function updateTruck(t){
  if(t.removed)return false;
  t.x+=t.speed*t.direction;
  if(t.direction>0?t.x>maxCells:t.x<-20){
    t.element.remove(); return false;
  }
  t.element.style.transform=`translateX(${t.x*10}px)`;
  checkCollision(t); return true;
}
function updateMotorcyclist(mc){
  if(mc.removed)return false;
  mc.x+=mc.speed*mc.direction;
  if(mc.direction>0?mc.x>maxCells:mc.x<-10){
    mc.elements.forEach(e=>e.remove()); return false;
  }
  mc.elements.forEach(e=>e.style.transform=`translateX(${mc.x*10}px)`);
  checkMotorcyclists(mc); return true;
}

let active=true;
document.addEventListener("visibilitychange",()=>{active=!document.hidden});
function animate(){
  if(gameOver)return;
  updateScore();
  cars=cars.filter(updateCar);
  fastCars=fastCars.filter(updateCar);
  trucks=trucks.filter(updateTruck);
  motorcyclists=motorcyclists.filter(updateMotorcyclist);
  if(active)requestAnimationFrame(animate);
  else setTimeout(animate,1000/15);
}
function updateScore(){
  const e=Date.now()-startTime;
  const m=Math.floor(e/60000).toString().padStart(2,'0');
  const s=Math.floor((e%60000)/1000).toString().padStart(2,'0');
  const t=Math.floor((e%1000)/100);
  document.getElementById('score').innerText=`${m}:${s}:${t}`;
}

function endGame(){
  gameOver=true;
  clearInterval(fastCarTimer);
  clearInterval(truckTimer);
  clearInterval(motoTimer);
  document.getElementById('gameover-text').innerText=
    `Гру закінчено.\nзагальний час - ${document.getElementById('score').innerText}\nуникнутих зіткнень: ${carsPassed}`;
  document.getElementById('gameover').style.display='flex';
}
function restartGame(){
  [...cars,...fastCars,...trucks,...motorcyclists].forEach(c=>{
    try{c.element.remove()}catch{};
    if(c.elements)c.elements.forEach(e=>e.remove());
  });
  cars=[]; fastCars=[]; trucks=[]; motorcyclists=[];
  carsPassed=0; kmh=20; gear=1; speedMultiplier=1; shields=0; lastSide=null; gameOver=false;
  document.getElementById('gameover').style.display='none';
  startGame();
}
function startGame(){
  initCars();
  startTime=Date.now();
  animate();
  updateHud();
  fastCarTimer = setInterval(spawnFastCar, 10000); 
  truckTimer   = setInterval(spawnTruck, 7000);
  motoTimer    = setInterval(spawnMotorcyclists, 5000);
}
initLanes();
startGame();
window.addEventListener('resize',()=>{maxCells=Math.floor(innerWidth/10)});
</script>
</body>
</html>
