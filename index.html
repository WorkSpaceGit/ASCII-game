<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>ASCII-гра</title>
<style>
body {
  margin:0; height:100vh; background:black;
  font-family:monospace; white-space:pre; overflow:hidden;
}
.car { position:absolute; font-weight:bold; }
.lane, .divider { position:absolute; width:100%; }
.lane { border-top:1px solid gray; opacity:0.3; }
.divider { border-top:4px double yellow; opacity:0.8; }
#player {
  position:absolute; font-weight:bold; font-size:24px;
  left:50%; transform:translateX(-50%);
}
#score {
  position:absolute; top:230px; left:50%;
  transform:translateX(-50%); color:white; font-size:20px;
}
#hud {
  position:absolute; top:260px; left:50%;
  transform:translateX(-50%); color:lime; font-size:18px;
  transition: color 0.3s;
}
#gameover {
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-50%); color:red; font-size:28px;
  display:none; flex-direction:column; align-items:center; text-align:center;
}
#gameover #gameover-text { margin-bottom:20px; white-space:pre-line; }
button {
  font-size:20px; padding:10px 20px; margin:5px;
  background:#222; color:white; border:1px solid gray; border-radius:8px;
}
#controls {
  position:absolute; bottom:50px; left:50%;
  transform:translateX(-50%);
}
</style>
</head>
<body>

<div id="gameover">
  <div id="gameover-text"></div>
  <button onclick="restartGame()">Почати спочатку</button>
</div>

<div id="controls">
  <button onclick="movePlayer(-1)">⬆</button>
  <button onclick="movePlayer(1)">⬇</button>
</div>

<div id="score">00:00:0</div>
<div id="hud"></div>
<div id="player">:=[:]=:</div>

<script>
const carSprites = ['=(o)≡','≡[+]≡','(o)=(o)=[:]','=[:]=','<[•)>','=[-]=','[]=o=[]','<(o)>'];
const carColors  = ['red','orange','yellow','lime','cyan','blue','magenta','white'];
const laneCount = 3;
const laneHeight = 30;
const safeDistance = 7;
let laneTops = [];
let maxCells = Math.floor(window.innerWidth / 10);
let speedMultiplier = 1;
let gameOver = false;
let fastCarsSpawned = 0;
let startTime;
let cars = [], fastCars = [], trucks = [], motorcyclists = [];

let carsPassed = 0;
let kmh = 20;
let gear = 1;
let shields = 0;
let lastSide = null;
const gearNames = ["ПЕРША","ДРУГА","ТРЕТЯ","ЧЕТВЕРТА","П’ЯТА"];

// інтервали для ворогів
let truckInterval=null, motoInterval=null;

const player = document.getElementById('player');
let playerLane = laneCount;

// HUD
function updateHud(highlight=false){
  const hud = document.getElementById('hud');
  hud.innerText = `Швидкість: ${kmh} км/год || Передача: ${gearNames[gear-1]} || Уникнутих авто: ${carsPassed} || Щити: ${shields}`;
  hud.style.color = highlight ? "yellow" : "lime";
  if(highlight){
    setTimeout(()=>{ if(!gameOver) hud.style.color="lime"; },1000);
  }
}

// Ініціалізація доріжок
function initLanes() {
  laneTops = Array.from({length: laneCount*2}, (_,i)=>i*laneHeight + (i>=laneCount?laneHeight/2:0));
  laneTops.forEach(t=>addElement('lane', t));
  [laneCount*laneHeight, laneCount*laneHeight + laneHeight/2].forEach(t=>addElement('divider', t));
  addElement('lane', laneTops.at(-1)+laneHeight);
}
function addElement(cls, top){
  const el = document.createElement('div');
  el.className = cls;
  el.style.top = top+'px';
  document.body.appendChild(el);
  return el;
}

// Рух гравця
function updatePlayerPos(){ player.style.top = (laneTops[playerLane]+5)+'px'; }
updatePlayerPos();
function movePlayer(dir){
  const prevLane = playerLane;
  playerLane = Math.max(0, Math.min(laneTops.length-1, playerLane+dir));
  updatePlayerPos();

  if(playerLane === 0) lastSide = 0;
  if(playerLane === laneTops.length-1 && lastSide === 0){
    shields++;
    lastSide = null;
    updateHud(true);
  }
  if(playerLane === laneTops.length-1) lastSide = 1;
  if(playerLane === 0 && lastSide === 1){
    shields++;
    lastSide = null;
    updateHud(true);
  }
}
document.addEventListener('keydown', e=>{
  if(e.key==='ArrowUp') movePlayer(-1);
  if(e.key==='ArrowDown') movePlayer(1);
});

// Маячки гравця
function animatePlayerLights(){
  player.innerHTML = player.innerText.split('').map(ch=>{
    if(ch===':') return `<span style="color:${Math.random()>0.5?'red':'blue'}">:</span>`;
    if(ch==='=') return `<span style="color:${Math.random()>0.5?'blue':'white'}">=</span>`;
    return ch;
  }).join('');
}

// Ініціалізація авто
function initCars(){
  carSprites.forEach((sprite,i)=>{
    const lane = i % (laneCount*2);
    const el = document.createElement('div');
    el.className='car';
    el.innerText = sprite;
    el.style.color = carColors[i % carColors.length];
    el.style.top = laneTops[lane] + (lane===laneCount?12:5)+'px';
    document.body.appendChild(el);
    cars.push({
      element: el,
      x: Math.random()*maxCells,
      speed: (0.5 + Math.random()*2)/16,
      direction: lane < laneCount ? -1 : 1,
      lane, fast:false, removed:false
    });
  });
}

// Спавн швидких авто
function spawnFastCar(){
  if(gameOver) return;
  const lane = Math.floor(Math.random()*laneTops.length);
  const el = document.createElement('div');
  el.className='car';
  el.innerText='(o)=(o)';
  el.style.top=laneTops[lane]+5+'px';
  document.body.appendChild(el);
  const fastCar = {
    element: el,
    x: lane<laneCount?maxCells+5:-5,
    speed: ((0.5 + Math.random()*2)/16)*15,
    direction: lane<laneCount?-1:1,
    lane, fast:true, colorInterval:null, removed:false
  };
  fastCar.colorInterval = setInterval(()=>{
    if(gameOver){ clearInterval(fastCar.colorInterval); return; }
    el.style.color = ['red','yellow','lime','cyan','magenta','white'][Math.floor(Math.random()*6)];
  },200);
  fastCars.push(fastCar);
}

// Спавн вантажівок
function spawnTruck(){
  if(gameOver) return;
  const lane = Math.floor(Math.random()*laneTops.length);
  const el = document.createElement('div');
  el.className='car';
  el.innerText='[=====TRUCK=====]';
  el.style.color='gray';
  el.style.top=laneTops[lane]+5+'px';
  document.body.appendChild(el);
  trucks.push({
    element: el,
    x: lane<laneCount?maxCells+5:-20,
    speed: ((0.5 + Math.random()*2)/16)*2,
    direction: lane<laneCount?-1:1,
    lane, removed:false
  });
}

// Спавн мотоциклістів
function spawnMotorcyclists(){
  if(gameOver) return;
  const lane = Math.floor(Math.random()*(laneTops.length-1));
  const el1 = document.createElement('div');
  const el2 = document.createElement('div');
  el1.className='car'; el2.className='car';
  el1.innerText='(o)≡(o)';
  el2.innerText='(o)≡(o)';
  el1.style.color='white';
  el2.style.color='white';
  el1.style.top=laneTops[lane]+5+'px';
  el2.style.top=laneTops[lane+1]+5+'px';
  document.body.appendChild(el1);
  document.body.appendChild(el2);
  motorcyclists.push({
    elements:[el1,el2],
    x: lane<laneCount?maxCells+5:-10,
    speed: ((0.5 + Math.random()*2)/16)*4,
    direction: lane<laneCount?-1:1,
    lanes:[lane,lane+1],
    removed:false
  });
}
// Колізії
function checkCollision(car){
  if(car.removed) return;

  const carLeft = car.x*10,
        carRight = carLeft + (car.element && car.element.innerText ? car.element.innerText.length*10 : 0),
        playerLeft = parseFloat(player.offsetLeft),
        playerRight = playerLeft + player.offsetWidth;
  if(car.lane===playerLane && !(carRight<playerLeft || carLeft>playerRight)){
    if(shields > 0){
      shields--;
      updateHud(true);
      if(car.element) car.element.remove();
      car.removed = true;
      return;
    } else {
      endGame();
    }
  }
}

// Колізії для мотоциклістів
function checkMotorcyclists(mc){
  if(mc.removed) return;
  const playerLeft = parseFloat(player.offsetLeft);
  const playerRight = playerLeft + player.offsetWidth;
  mc.lanes.forEach((lane,i)=>{
    if(lane===playerLane){
      const el = mc.elements[i];
      const carLeft = mc.x*10;
      const carRight = carLeft + el.innerText.length*10;
      if(!(carRight<playerLeft || carLeft>playerRight)){
        if(shields>0){
          shields--;
          updateHud(true);
          mc.elements.forEach(e=>e.remove());
          mc.removed=true;
        } else {
          endGame();
        }
      }
    }
  });
}

// Швидкість авто
function adjustSpeed(car){
  const slowed = cars.some(other=>other!==car && other.lane===car.lane &&
    ((car.direction>0 && other.x>car.x && other.x-car.x<safeDistance) ||
     (car.direction<0 && car.x>other.x && car.x-other.x<safeDistance))
  );
  car.currentSpeed = slowed ? car.speed*0.3 : car.speed;
}

// Кінець гри
function endGame(){
  gameOver=true;
  clearInterval(playerLightsInterval);
  if(truckInterval) clearInterval(truckInterval);
  if(motoInterval) clearInterval(motoInterval);
  fastCars.forEach(c=>{ if(c.colorInterval) clearInterval(c.colorInterval); });
  document.getElementById('gameover-text').innerText=
    `Гру закінчено.\nзагальний час - ${document.getElementById('score').innerText}\nуникнутих зіткнень: ${carsPassed}`;
  document.getElementById('gameover').style.display='flex';
}

// Рестарт
function restartGame(){
  [...cars, ...fastCars, ...trucks, ...motorcyclists].forEach(c=>{
    try { if(c.colorInterval) clearInterval(c.colorInterval); } catch(e){}
    try { if(c.element) c.element.remove(); } catch(e){}
    try { if(c.elements) c.elements.forEach(e=>e.remove()); } catch(e){}
  });
  cars=[]; fastCars=[]; trucks=[]; motorcyclists=[];
  fastCarsSpawned=0; carsPassed=0; kmh=20; gear=1; speedMultiplier=1; shields=0; lastSide=null;
  gameOver=false;
  if(truckInterval) clearInterval(truckInterval);
  if(motoInterval) clearInterval(motoInterval);
  document.getElementById('gameover').style.display='none';
  startTime=Date.now();
  initCars();
  requestAnimationFrame(mainLoop);
  playerLightsInterval = setInterval(animatePlayerLights,300);
  updateHud();
  startIntervals();
}

// Таймер
function updateScore(){
  const elapsed = Date.now()-startTime;
  const min = Math.floor(elapsed/60000).toString().padStart(2,'0');
  const sec = Math.floor((elapsed%60000)/1000).toString().padStart(2,'0');
  const tenths = Math.floor((elapsed%1000)/100);
  document.getElementById('score').innerText=`${min}:${sec}:${tenths}`;
}

// Основна анімація авто
function updateCar(car){
  if(car.removed){
    try { if(car.element) car.element.remove(); } catch(e){}
    return false;
  }

  if(car.fast) car.x += car.speed*car.direction*speedMultiplier;
  else { adjustSpeed(car); car.x += (car.currentSpeed||car.speed)*car.direction*speedMultiplier; }

  const offscreen = car.direction>0? car.x>maxCells : car.x<-car.element.innerText.length;
  if(offscreen){
    if(car.fast){
      if(car.element) car.element.remove();
      return false;
    } else {
      car.x = car.direction>0?-car.element.innerText.length:maxCells;
      carsPassed++;
      updateHud();

      if(carsPassed % 5 === 0){ kmh += 5; }
      if(carsPassed % 10 === 0 && gear < 5){
        speedMultiplier = Math.min(speedMultiplier+0.5,5);
        gear++; kmh += 5; updateHud(true);
      }
    }
  }
  if(car.element) car.element.style.left = (car.x*10)+'px';
  checkCollision(car);
  return true;
}

// Оновлення вантажівок
function updateTruck(truck){
  if(truck.removed){ try { truck.element.remove(); } catch(e){}; return false; }
  truck.x += truck.speed*truck.direction*speedMultiplier;
  const offscreen = truck.direction>0? truck.x>maxCells : truck.x<-20;
  if(offscreen){ truck.element.remove(); return false; }
  truck.element.style.left=(truck.x*10)+'px';
  checkCollision(truck);
  return true;
}

// Оновлення мотоциклістів
function updateMotorcyclists(mc){
  if(mc.removed){ return false; }
  mc.x += mc.speed*mc.direction*speedMultiplier;
  const offscreen = mc.direction>0? mc.x>maxCells : mc.x<-10;
  if(offscreen){ mc.elements.forEach(e=>e.remove()); return false; }
  mc.elements.forEach(e=>{ e.style.left=(mc.x*10)+'px'; });
  checkMotorcyclists(mc);
  return true;
}

// Головний цикл
function mainLoop(){
  if(gameOver) return;
  updateScore();

  for(let i=cars.length-1;i>=0;i--){ if(!updateCar(cars[i])) cars.splice(i,1); }
  for(let i=fastCars.length-1;i>=0;i--){ if(!updateCar(fastCars[i])) fastCars.splice(i,1); }
  for(let i=trucks.length-1;i>=0;i--){ if(!updateTruck(trucks[i])) trucks.splice(i,1); }
  for(let i=motorcyclists.length-1;i>=0;i--){ if(!updateMotorcyclists(motorcyclists[i])) motorcyclists.splice(i,1); }

  requestAnimationFrame(mainLoop);
}

// Запуск інтервалів
function startIntervals(){
  setInterval(spawnFastCar, 3000 + Math.random()*4000);
  truckInterval = setInterval(()=>{ if(carsPassed>=70) spawnTruck(); }, 12000);
  motoInterval = setInterval(()=>{ 
    if(carsPassed>=100){ 
      const delay = Math.max(5000 - kmh*20, 1000);
      if(Math.random()<0.5) spawnMotorcyclists();
    }
  }, 4000);
}

// Запуск гри
initLanes();
initCars();
startTime = Date.now();
let playerLightsInterval = setInterval(animatePlayerLights,300);
requestAnimationFrame(mainLoop);
updateHud();
startIntervals();

// Адаптивність при resize
window.addEventListener('resize',()=>{ maxCells=Math.floor(window.innerWidth/10); });
</script>
</body>
</html>
